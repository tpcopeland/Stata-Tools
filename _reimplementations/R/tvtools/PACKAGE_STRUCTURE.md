# tvtools R Package Structure

## Overview

This document describes the complete structure of the tvtools R package, created on 2025-12-02.

## Package Information

- **Name**: tvtools
- **Version**: 0.1.0 (Development)
- **License**: MIT
- **Author**: Timothy P. Copeland (Karolinska Institutet)
- **Description**: Time-Varying Exposure and Event Analysis Tools for R

## Directory Structure

```
tvtools/
â”œâ”€â”€ .Rbuildignore              # Files to exclude from package build
â”œâ”€â”€ .gitignore                 # Git ignore patterns
â”œâ”€â”€ CONTRIBUTING.md            # Contribution guidelines
â”œâ”€â”€ DESCRIPTION                # Package metadata and dependencies
â”œâ”€â”€ INSTALL.md                 # Installation instructions
â”œâ”€â”€ LICENSE                    # MIT License text
â”œâ”€â”€ NAMESPACE                  # Package namespace (exports/imports)
â”œâ”€â”€ NEWS.md                    # Version history and changelog
â”œâ”€â”€ README.md                  # Main package documentation
â”œâ”€â”€ PACKAGE_STRUCTURE.md       # This file
â”‚
â”œâ”€â”€ R/                         # R source code
â”‚   â”œâ”€â”€ tvevent.R             # Event integration function
â”‚   â”œâ”€â”€ tvexpose.R            # Exposure variable creation function
â”‚   â”œâ”€â”€ tvmerge.R             # Time-varying dataset merging function
â”‚   â””â”€â”€ tvtools-package.R     # Package-level documentation
â”‚
â”œâ”€â”€ man/                       # Documentation (generated by roxygen2)
â”‚   â””â”€â”€ (to be generated)
â”‚
â”œâ”€â”€ tests/                     # Test suite
â”‚   â”œâ”€â”€ testthat.R            # Testthat configuration
â”‚   â””â”€â”€ testthat/
â”‚       â”œâ”€â”€ test_tvevent_basic.R   # Tests for tvevent()
â”‚       â””â”€â”€ test_tvmerge_basic.R   # Tests for tvmerge()
â”‚
â”œâ”€â”€ vignettes/                 # Long-form documentation
â”‚   â””â”€â”€ tvtools-intro.Rmd     # Introduction vignette
â”‚
â””â”€â”€ data-raw/                  # Raw data for examples (empty)
```

## File Descriptions

### Root Files

#### DESCRIPTION
- Package metadata (name, version, authors)
- Dependencies and imports
- License information
- URLs and bug reports

#### NAMESPACE
- Exports: tvevent, tvexpose, tvmerge
- Imports from: dplyr, data.table, tibble, haven, rlang, tidyr, lubridate

#### README.md
- Package overview
- Installation instructions
- Quick start examples for all three functions
- Complete workflow example
- Function reference summary
- Links to original Stata package

#### LICENSE
- Full MIT License text
- Copyright holder: Timothy P. Copeland

#### NEWS.md
- Version 0.1.0 release notes
- Initial features
- Known limitations
- Future plans

### Source Code (R/)

#### tvevent.R
- **Function**: `tvevent()`
- **Purpose**: Integrate outcome events and competing risks into time-varying datasets
- **Key Features**:
  - Resolves competing risks
  - Splits intervals at event times
  - Adjusts continuous variables proportionally
  - Creates event status flags
  - Handles recurring vs single events
- **Lines**: ~750 (including roxygen2 documentation)

#### tvexpose.R
- **Function**: `tvexpose()`
- **Purpose**: Create time-varying exposure variables from period-based data
- **Key Features**:
  - Multiple exposure definitions (basic, ever-treated, current/former, duration, continuous, recency)
  - Grace periods and gap filling
  - Overlap resolution (priority, layering, splitting)
  - Lag and washout periods
  - Comprehensive validation
- **Lines**: ~1,600 (including roxygen2 documentation)

#### tvmerge.R
- **Function**: `tvmerge()`
- **Purpose**: Merge multiple time-varying datasets with temporal alignment
- **Key Features**:
  - Cartesian product of overlapping periods
  - Continuous vs categorical exposure handling
  - Batch processing for memory efficiency
  - Coverage validation
  - Multiple dataset support (2+)
- **Lines**: ~1,000 (including roxygen2 documentation)

#### tvtools-package.R
- Package-level documentation
- Overall workflow description
- Links to main functions
- Author information

### Tests (tests/)

#### test_tvevent_basic.R
- Basic functionality tests
- Edge case handling
- Input validation
- Event integration correctness

#### test_tvmerge_basic.R
- Merge correctness tests
- Multiple dataset handling
- Overlap computation
- Batch processing

**Note**: Test for tvexpose() to be added in future development.

### Documentation

#### README.md Features
- Workflow diagram
- Five complete examples:
  1. Basic time-varying exposure
  2. Cumulative duration
  3. Merge multiple exposures
  4. Add events
  5. Complete workflow with survival analysis
- Function reference with key parameters
- Links to Stata package

#### INSTALL.md
- Three installation methods
- Dependency information
- Troubleshooting guide
- Verification steps
- Update instructions

#### CONTRIBUTING.md
- Bug reporting guidelines
- Pull request workflow
- Code style guidelines
- Testing requirements
- Stata compatibility notes

#### Vignette (tvtools-intro.Rmd)
- Introduction to package
- Basic example walkthrough
- Advanced multi-exposure example
- Exposure type demonstrations
- Links to resources

## Dependencies

### Required (Imports)
- **dplyr** (â‰¥ 1.0.0): Data manipulation
- **data.table** (â‰¥ 1.14.0): High-performance operations
- **tibble** (â‰¥ 3.0.0): Modern data frames
- **haven** (â‰¥ 2.4.0): Stata file I/O
- **rlang** (â‰¥ 0.4.0): Tidy evaluation
- **tidyr** (â‰¥ 1.1.0): Data tidying
- **lubridate** (â‰¥ 1.7.0): Date handling

### Suggested
- **testthat** (â‰¥ 3.0.0): Testing framework
- **knitr**: Vignette building
- **rmarkdown**: Documentation
- **survival**: Survival analysis examples

### System Requirements
- R â‰¥ 4.0.0

## Installation

### From GitHub
```r
devtools::install_github(
  "tpcopeland/Stata-Tools",
  subdir = "Reimplementations/R/tvtools"
)
```

### From Local Source
```r
devtools::install_local("path/to/tvtools")
```

## Usage

```r
library(tvtools)

# Step 1: Create time-varying exposures
tv_data <- tvexpose(master_data, exposure_file, ...)

# Step 2 (optional): Merge multiple exposures
merged <- tvmerge(datasets = list(tv1, tv2), ...)

# Step 3: Add events
final <- tvevent(intervals_data, events_data, ...)

# Step 4: Survival analysis
library(survival)
coxph(Surv(start, stop, event) ~ exposure, data = final$data)
```

## Key Features

### Comprehensive Exposure Definitions
- Basic time-varying (changes at each exposure period)
- Ever-treated (binary switch at first exposure)
- Current/former (never/current/former categories)
- Duration categories (cumulative exposure bins)
- Continuous cumulative (total exposure time)
- Recency (time since last exposure)

### Advanced Data Handling
- Grace periods (merge close gaps)
- Gap filling (assume continuation)
- Carry forward (extend through gaps)
- Lag periods (delayed effect)
- Washout periods (persistence after stop)
- Priority-based overlap resolution

### Validation & Diagnostics
- Coverage checking
- Gap detection
- Overlap identification
- Summary statistics
- Batch processing progress

### Performance Optimization
- data.table for speed
- Batch processing for memory
- Efficient date operations
- Minimal data copying

## Differences from Stata Version

### Maintained
- Core algorithm logic
- Parameter names (where possible)
- Output structure
- Validation approach

### Adapted for R
- Uses tibbles/data.frames instead of Stata datasets
- Returns list objects with data + diagnostics
- Date handling via lubridate
- Leverages dplyr/data.table for efficiency
- Native R data types

### Not Yet Implemented
- Some advanced diagnostic plots
- Dialog-based interface (Stata has .dlg files)
- Stata-specific file handling options

## Future Development

### Planned Features
- Additional test coverage (especially tvexpose)
- More comprehensive vignettes
- Performance benchmarking
- Additional validation checks
- Helper functions for data preparation
- Examples with real-world datasets

### Potential Enhancements
- Parallel processing option
- Progress bars for long operations
- Interactive diagnostics
- Integration with tidymodels
- Shiny interface for exploration

## Version History

### 0.1.0 (Current - Development)
- Initial R implementation
- Three core functions implemented
- Basic test suite
- Comprehensive documentation
- Package infrastructure complete

## Links & Resources

- **GitHub Repository**: https://github.com/tpcopeland/Stata-Tools
- **Original Stata Package**: https://github.com/tpcopeland/Stata-Tools/tree/main/tvtools
- **Issues**: https://github.com/tpcopeland/Stata-Tools/issues
- **Email**: timothy.copeland@ki.se

## Notes for Developers

### Building Package
```r
# Document (generate man/ from roxygen2)
devtools::document()

# Run tests
devtools::test()

# Check package
devtools::check()

# Build tarball
devtools::build()

# Install locally
devtools::install()
```

### Generating Documentation
```r
# Update all documentation
roxygen2::roxygenise()

# Build vignettes
devtools::build_vignettes()

# Build manual
devtools::build_manual()
```

### Code Style
- Follow tidyverse style guide
- Use snake_case for functions/variables
- Document all exported functions with roxygen2
- Include examples in documentation
- Write tests for new features

## Package Status

âœ… **Complete**:
- Package structure
- Three core functions
- Basic tests
- Comprehensive documentation
- Installation guides
- README with examples
- Vignette framework
- License and contributing guides

â³ **In Progress**:
- Test coverage for tvexpose
- Additional vignettes
- Performance optimization

ðŸ“‹ **Planned**:
- CRAN submission preparation
- Additional helper functions
- Extended examples
- Performance benchmarks

---

**Last Updated**: 2025-12-02
**Package Version**: 0.1.0 (Development)
**Status**: Ready for installation and testing
